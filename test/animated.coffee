animationData = `{
   "version":"1.3",
   "tileset":[
      {
         "id":12354,
         "src":"http://images.pixie.strd6.com/sprites/12354/original.png?1300575176",
         "title":"Sprite 12354",
         "circles":[
            {
               "x":0,
               "y":2,
               "radius":40
            },
            {
               "x":90,
               "y":-40,
               "radius":30
            },
            {
               "x":-80,
               "y":10,
               "radius":15
            },
            {
               "x":0,
               "y":51,
               "radius":50
            },
            {
               "x":-120,
               "y":22,
               "radius":12
            }
         ]
      },
      {
         "id":12355,
         "src":"http://images.pixie.strd6.com/sprites/12355/original.png?1300575193",
         "title":"Sprite 12355",
         "circles":[
            {
               "x":0,
               "y":0,
               "radius":40
            },
            {
               "x":90,
               "y":-20,
               "radius":35
            },
            {
               "x":-80,
               "y":20,
               "radius":20
            },
            {
               "x":0,
               "y":50,
               "radius":50
            }
         ]
      },
      {
         "id":12356,
         "src":"http://images.pixie.strd6.com/sprites/12356/original.png?1300575271",
         "title":"Sprite 12356",
         "circles":[
            {
               "x":0,
               "y":0,
               "radius":40
            },
            {
               "x":71,
               "y":-55,
               "radius":35
            },
            {
               "x":-79,
               "y":20,
               "radius":20
            },
            {
               "x":0,
               "y":51,
               "radius":50
            }
         ]
      },
      {
         "id":12358,
         "src":"http://images.pixie.strd6.com/sprites/12358/original.png?1300575302",
         "title":"Sprite 12358",
         "circles":[
            {
               "x":0,
               "y":0,
               "radius":40
            },
            {
               "x":70,
               "y":-56,
               "radius":40
            },
            {
               "x":-67,
               "y":14,
               "radius":20
            },
            {
               "x":0,
               "y":50,
               "radius":50
            }
         ]
      },
      {
         "id":12359,
         "src":"http://images.pixie.strd6.com/sprites/12359/original.png?1300575324",
         "title":"Sprite 12359",
         "circles":[
            {
               "x":0,
               "y":10,
               "radius":40
            },
            {
               "x":-70,
               "y":-30,
               "radius":15
            },
            {
               "x":0,
               "y":50,
               "radius":50
            }
         ]
      },
      {
         "id":12360,
         "src":"http://images.pixie.strd6.com/sprites/12360/original.png?1300575342",
         "title":"Sprite 12360",
         "circles":[
            {
               "x":0,
               "y":10,
               "radius":40
            },
            {
               "x":-80,
               "y":-30,
               "radius":20
            },
            {
               "x":0,
               "y":50,
               "radius":45
            }
         ]
      },
      {
         "id":12361,
         "src":"http://images.pixie.strd6.com/sprites/12361/original.png?1300575359",
         "title":"Sprite 12361",
         "circles":[
            {
               "x":0,
               "y":8,
               "radius":40
            },
            {
               "x":104,
               "y":0,
               "radius":35
            },
            {
               "x":-84,
               "y":6,
               "radius":20
            },
            {
               "x":0,
               "y":50,
               "radius":50
            }
         ]
      },
      {
         "id":12362,
         "src":"http://images.pixie.strd6.com/sprites/12362/original.png?1300575379",
         "title":"Sprite 12362",
         "circles":[
            {
               "x":0,
               "y":1,
               "radius":40
            },
            {
               "x":90,
               "y":-38,
               "radius":30
            },
            {
               "x":-80,
               "y":10,
               "radius":20
            },
            {
               "x":0,
               "y":50,
               "radius":50
            }
         ]
      },
      {
         "id":12448,
         "src":"http://images.pixie.strd6.com/sprites/12448/original.png?1300944508",
         "title":"Idle1-1",
       "circles":[

         ]
      },
      {
         "id":12449,
         "src":"http://images.pixie.strd6.com/sprites/12449/original.png?1300944544",
         "title":"Idle1-2",
       "circles":[

         ]
      },
      {
         "id":12450,
         "src":"http://images.pixie.strd6.com/sprites/12450/original.png?1300944589",
         "title":"Idle1-3",
       "circles":[

         ]
      },
      {
         "id":12451,
         "src":"http://images.pixie.strd6.com/sprites/12451/original.png?1300944615",
         "title":"Idle1-4",
       "circles":[

         ]
      },
      {
         "id":12456,
         "src":"http://images.pixie.strd6.com/sprites/12456/original.png?1300945175",
         "title":"walk1",
       "circles":[

         ]
      },
      {
         "id":12457,
         "src":"http://images.pixie.strd6.com/sprites/12457/original.png?1300945201",
         "title":"walk2",
       "circles":[

         ]
      },
      {
         "id":12458,
         "src":"http://images.pixie.strd6.com/sprites/12458/original.png?1300945225",
         "title":"walk3",
       "circles":[

         ]
      },
      {
         "id":12459,
         "src":"http://images.pixie.strd6.com/sprites/12459/original.png?1300945249",
         "title":"walk4",
       "circles":[

         ]
      },
      {
         "id":12460,
         "src":"http://images.pixie.strd6.com/sprites/12460/original.png?1300945279",
         "title":"walk5",
       "circles":[

         ]
      },
      {
         "id":12461,
         "src":"http://images.pixie.strd6.com/sprites/12461/original.png?1300945300",
         "title":"walk6",
       "circles":[

         ]
      },
      {
         "id":12462,
         "src":"http://images.pixie.strd6.com/sprites/12462/original.png?1300945319",
         "title":"walk7",
       "circles":[

         ]
      },
      {
         "id":12463,
         "src":"http://images.pixie.strd6.com/sprites/12463/original.png?1300945343",
         "title":"walk8",
       "circles":[

         ]
      },
      {
         "id":12452,
         "src":"http://images.pixie.strd6.com/sprites/12452/original.png?1300944656",
         "title":"Idle2-1",
       "circles":[

         ]
      },
      {
         "id":12453,
         "src":"http://images.pixie.strd6.com/sprites/12453/original.png?1300944682",
         "title":"Idle2-2",
       "circles":[

         ]
      },
      {
         "id":12454,
         "src":"http://images.pixie.strd6.com/sprites/12454/original.png?1300944707",
         "title":"Idle2-3",
       "circles":[

         ]
      },
      {
         "id":12455,
         "src":"http://images.pixie.strd6.com/sprites/12455/original.png?1300944729",
         "title":"Idle2-4",
       "circles":[

         ]
      },
      {
         "id":12411,
         "src":"http://images.pixie.strd6.com/sprites/12411/original.png?1300844954",
         "title":"Sprite 12411",
       "circles":[

         ]
      }
   ],
   "animations":[
      {
         "name":"Bite",
         "complete":"Idle1",
         "interruptible":false,
         "speed":"110",
         "transition":[{hflip: true, vflip: true}],
         "triggers": {
           "0":["whiteParticles"],
           "4":["blueParticles","greenParticles"],
           "5":["chompSound"]
         },
         "frames":[0,1,2,3,4,5,6,7]
      },
      {   
         "complete":"Idle1",
         "interruptible":true,
         "name":"Idle1",
         "speed":"110",
         "frames":[8,9,10,11]
      },
      {     
         "complete":"Walk",
         "interruptible":true,
         "name":"Walk",
         "speed":"110",
         "frames":[12,13,14,15,16,17,18,19]
      },
      {
         "complete":"Idle1",
         "interruptible":true,
         "name":"Idle2",
         "speed":"110",
         "frames":[20,21,22,23]
      },
      {  
         "complete":"Fly",
         "interruptible":true,
         "name":"Fly",
         "speed":"110",
         "frames":[24]
      }
   ]  
}`

module "Animation"

test "should set proper frame", ->
  animation = GameObject
    data: animationData
    includedModules: ["Animated"]

  equals animation.I.currentFrameIndex, animation.I.activeAnimation.frames.first(), "Animation should default to initial sprite"

  animation.update()

  equals animation.I.currentFrameIndex, animation.I.activeAnimation.frames[1], "After an update the currentFrameIndex has advanced"

  (animation.I.activeAnimation.frames.length - 1).times ->
    animation.update()

  equals animation.I.currentFrameIndex, 0, "Animation should loop after it reaches the end"

test "should be on correct frame after transition is called", ->
  animation = GameObject
    data: animationData
    includedModules: ["Animated"]

  # Bite cannot be interrupted. Hack to get to idle state
  8.times -> animation.update()

  equals animation.I.activeAnimation.name, "Idle1", "Animation should be in idle1 state after bite finishes"

  animation.transition("Idle2")

  equals animation.I.activeAnimation.name, "Idle2", "Animation should be in idle2 state after transition is called"
  equals animation.I.activeAnimation.frames.first(), 20, "Animation should be on first frame after transition"

test "should fire Complete event after updating past the last frame", ->
  completeFired = false

  animation = GameObject
    data: animationData
    includedModules: ["Animated"]

  animation.bind "Complete", ->
    completeFired = true

  animation.I.activeAnimation.frames.length.times ->
    animation.update()

  ok completeFired, "Complete event fired"

test "should advance to next state after last frame", ->
  animation = GameObject
    data: animationData
    includedModules: ["Animated"]

  animation.I.activeAnimation.frames.length.times ->
    animation.update()

  equals animation.I.activeAnimation.name, "Idle1", "After the bite cycle we should end up in the Idle1 state"

  50.times -> animation.update()

  equals animation.I.activeAnimation.name, "Idle1", "The idle1 state loops, so after any number of updates we should still be there"

test "should fire frame specific event on the proper frame", ->
  whiteParticlesFired = blueParticlesFired = greenParticlesFired = chompSoundFired = false

  animation = GameObject
    data: animationData
    includedModules: ["Animated"]

  animation.bind "whiteParticles", ->
    whiteParticlesFired = true

  animation.bind "blueParticles", ->
    blueParticlesFired = true

  animation.bind "greenParticles", ->
    greenParticlesFired = true

  animation.bind "chompSound", ->
    chompSoundFired = true

  animation.update()

  ok whiteParticlesFired, "White particle effect fired"

  animation.update()
  animation.update()
  animation.update()
  animation.update()

  ok blueParticlesFired, "Blue particle effect fired"
  ok greenParticlesFired, "Green particle effect fired"

  animation.update()

  ok chompSoundFired, "Chomp sound effect fired"

module()

